<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>订单流程 | Jeskson文档-微服务分布式系统架构</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Jeskson文档-架构师">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/JavaPlusDoc/assets/css/0.styles.15f90da9.css" as="style"><link rel="preload" href="/JavaPlusDoc/assets/js/app.acda7e78.js" as="script"><link rel="preload" href="/JavaPlusDoc/assets/js/7.6b95bcd8.js" as="script"><link rel="preload" href="/JavaPlusDoc/assets/js/2.d0a351ba.js" as="script"><link rel="preload" href="/JavaPlusDoc/assets/js/1.b7861ce0.js" as="script"><link rel="preload" href="/JavaPlusDoc/assets/js/158.eddd1557.js" as="script"><link rel="prefetch" href="/JavaPlusDoc/assets/js/10.14567f2e.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/100.e5e28c95.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/101.cd3fefac.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/102.d6747995.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/103.4c5f5fdf.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/104.8d6b4ab0.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/105.5207ab74.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/106.76de2ee7.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/107.ce3774ec.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/108.cbb74bdf.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/109.55b16a30.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/11.5c5b9efd.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/110.d14f89ed.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/111.87f8f417.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/112.2cceac3a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/113.e6cab000.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/114.d114aca1.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/115.3a6a518a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/116.2574e0e9.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/117.04f37050.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/118.a5f52d7f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/119.8e6fd284.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/120.c56261b3.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/121.a86cf6c4.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/122.7d32297f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/123.65e8ed36.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/124.6e141878.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/125.18607c7b.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/126.bf344956.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/127.dadd45c5.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/128.9c82f804.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/129.ffbcfd2a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/130.e567a39a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/131.70ccb577.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/132.f1ea9f84.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/133.6e046b1f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/134.1740b513.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/135.6072d64f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/136.7f8a579d.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/137.e8e66a0f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/138.a600263e.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/139.9b68be2d.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/14.36ac74ea.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/140.1dac077c.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/141.fda85911.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/142.461c3f6f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/143.dbff9a27.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/144.9f39772c.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/145.05e48d8e.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/146.cec6fceb.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/147.7d444299.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/148.55ec6a96.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/149.6007d805.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/15.665e63cc.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/150.dbb9a37f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/151.2987107e.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/152.e383a0ed.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/153.c489187a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/154.8fb7258f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/155.59ca2296.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/156.4d57f8e8.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/157.df706982.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/159.e98d4288.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/16.b217169d.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/160.828fa8e1.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/161.8605274a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/162.923690da.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/163.c12adf47.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/164.bac8b83d.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/165.072be464.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/166.5b5bba49.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/167.6066f7d2.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/168.84f9e786.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/169.c902214a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/17.fbdb30e6.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/170.47b724b0.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/171.55fe2415.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/172.2bce72fa.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/173.063da93b.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/174.fde7b488.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/175.39954a56.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/176.026b854c.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/177.181d831f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/178.fc8b5d73.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/179.531da5b3.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/18.b45c9d58.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/180.3ef47163.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/181.3c5164d1.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/182.b49cae4f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/183.a0b152ce.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/184.da14dcd6.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/185.b1235cc1.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/186.f1a8f82b.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/187.1e86f8be.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/188.48473171.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/189.33a3a97a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/19.5c7d7f46.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/190.0867922a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/191.4e22ecce.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/192.2724fcbb.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/20.09ebd68a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/21.c0100739.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/22.6581fbb6.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/23.e1ab11d1.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/24.a9a010ce.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/25.5a82d4e3.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/26.1c2f07fb.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/27.a1400ebf.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/28.b249cc37.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/29.173b7a66.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/3.849d9745.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/30.6e8f83b2.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/31.459364d0.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/32.b1f3df61.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/33.3c7d358c.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/34.5d779e64.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/35.b1ea0e61.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/36.a76a65c2.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/37.f0aa41c4.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/38.fd9b549f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/39.f30c9a6c.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/4.a6be3d1d.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/40.cada9ea1.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/41.16efc438.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/42.60d376f8.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/43.b7f15248.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/44.c2a22a96.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/45.6bd626ea.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/46.ba73fec4.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/47.c43e6e6b.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/48.9e87201f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/49.b7478c8b.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/5.fdbeaa2f.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/50.d44ae2be.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/51.f21376db.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/52.f371c9dd.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/53.e2705176.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/54.9d510802.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/55.1e9a9a51.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/56.e8e4978a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/57.45bc81da.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/58.1f572ed3.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/59.7b716759.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/6.f6bf1b1e.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/60.c33704d9.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/61.e182c35e.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/62.35f14c89.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/63.23c70c05.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/64.9df86b46.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/65.31afecc1.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/66.793b4f42.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/67.de30b4c6.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/68.68c03d9e.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/69.8c946188.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/70.d5441472.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/71.55ebfe76.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/72.308b32c2.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/73.cff46774.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/74.13975781.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/75.5003271b.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/76.e8b64022.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/77.8fa6be96.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/78.822a532a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/79.2aa57d3a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/8.31d8184b.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/80.937a38ca.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/81.412f50bb.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/82.3dc371c3.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/83.3edd5ab1.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/84.2a96ad47.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/85.b6beedc8.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/86.242b4337.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/87.70ab97d0.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/88.f0122a44.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/89.06def01e.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/9.12f03790.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/90.84b88e79.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/91.e72de2d0.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/92.0e3b5f95.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/93.abd49b37.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/94.4a183c9a.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/95.8da7b472.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/96.1c301d4c.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/97.7be404e4.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/98.35a0f04d.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/99.01b25f6c.js"><link rel="prefetch" href="/JavaPlusDoc/assets/js/vendors~docsearch.7b0544ba.js">
    <link rel="stylesheet" href="/JavaPlusDoc/assets/css/0.styles.15f90da9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Jeskson文档-微服务分布式系统架构</h3> <p class="description" data-v-59e6cb88>Jeskson文档-架构师</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/JavaPlusDoc/" class="home-link router-link-active"><!----> <span class="site-name">Jeskson文档-微服务分布式系统架构</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/JavaPlusDoc/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="https://webvueblog.github.io/JavaPlusDoc/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  网站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/webVueBlog/JavaPlusDoc" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  星星
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      作者
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/webVueBlog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>154</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/JavaPlusDoc/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="https://webvueblog.github.io/JavaPlusDoc/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  网站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/webVueBlog/JavaPlusDoc" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  星星
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      作者
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/webVueBlog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/JavaPlusDoc/" class="sidebar-heading clickable router-link-active"><span>架构师</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/JavaPlusDoc/" aria-current="page" class="sidebar-link">学前必读</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/sre/sre" class="sidebar-heading clickable"><span>管理学</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/power/kafka" class="sidebar-heading clickable"><span>权威指南</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/linuxPrometheus/linux" class="sidebar-heading clickable"><span>运维与服务器</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/worker/1" class="sidebar-heading clickable"><span>工作</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/high-concurrency/why-cache" class="sidebar-heading clickable"><span>高并发架构</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/es/es-architecture" class="sidebar-heading clickable"><span>搜索引擎es</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/data/data" class="sidebar-heading clickable"><span>大数据</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/order/order-BizOrderService" class="sidebar-heading clickable open active"><span>订单流程</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/JavaPlusDoc/order/order-BizOrderService.html" aria-current="page" class="active sidebar-link">订单流程</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/tech/tech" class="sidebar-heading clickable"><span>技术文</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/MyBatis-Plus/getting-started" class="sidebar-heading clickable"><span>MyBatis-Plus</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/searchEngine/es-architecture" class="sidebar-heading clickable"><span>搜索引擎</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/mysql/mysql" class="sidebar-heading clickable"><span>mysql</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/nio/nio" class="sidebar-heading clickable"><span>nio</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/thread/thread" class="sidebar-heading clickable"><span>并发编程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/dubbo/dubbo" class="sidebar-heading clickable"><span>dubbo</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/linux/linux" class="sidebar-heading clickable"><span>运维</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/messagequeue/why-mq" class="sidebar-heading clickable"><span>消息队列</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/redis/rumen" class="sidebar-heading clickable"><span>Redis</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/cs/os" class="sidebar-heading clickable"><span>操作系统</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/iot/iot" class="sidebar-heading clickable"><span>物联网</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/java-up/nginx" class="sidebar-heading clickable"><span>Java进阶</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JavaPlusDoc/basic-grammar/basic-data-type" class="sidebar-heading clickable"><span>Java基础</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>订单流程</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">订单流程</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>哪吒</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2020/1/1</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><blockquote><p>点击勘误<a href="https://github.com/webVueBlog/JavaPlusDoc/issues" target="_blank" rel="noopener noreferrer">issues<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，哪吒感谢大家的阅读</p></blockquote> <img align="right" width="100" src="https://cdn.jsdelivr.net/gh/YunYouJun/yun/images/yun-alpha-compressed.png"> <h2 id="订单流程"><a href="#订单流程" class="header-anchor">#</a> 订单流程</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 预支付订单缓存键 &quot;pre_pay_order:&quot;;</span>
<span class="token comment">// 预优惠券缓存键 &quot;pre_coupon:&quot;;</span>

    <span class="token comment">// 超过多少天未支付，则视为逾期 overdueThr;</span>
    <span class="token comment">// 逾期支付的标准天数 payStd;</span>
    <span class="token comment">// 逾期支付的标准金额 12 amount;</span>
    <span class="token comment">// 改变批量费用规则的数量限制 0.5 countLimit;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">static</span> <span class="token class-name">BlockingQueue</span> blockingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//同一时间队列等待数最大超过100时，判定异常，允许抛出</span>
    <span class="token comment">// 创建一个固定大小的线程池，线程池的大小为当前可用处理器的数量，最大线程数为当前可用处理器的数量乘以4，线程空闲时间超过10秒则被回收</span>
    <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> fixedThreadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
            blockingQueue<span class="token punctuation">,</span><span class="token comment">// 队列容量</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 线程工厂</span>
                <span class="token comment">// 定义一个原子整数，用于生成线程的编号</span>
                <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> threadNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 定义线程的名称前缀</span>
                <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> namePrefix <span class="token operator">=</span> <span class="token string">&quot;xxxx&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 分账处理</span>
                <span class="token comment">// 重写newThread方法，用于创建线程</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 创建线程，并设置线程的名称为前缀加上线程编号</span>
                    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> namePrefix <span class="token operator">+</span> threadNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> t<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 获取预支付订单
 */</span>
<span class="token keyword">public</span> <span class="token class-name">BExchSvcOrder</span> <span class="token function">getCachePreOrderById</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 获取缓存中的预支付订单</span>
<span class="token punctuation">}</span>

<span class="token comment">// setRenewEndOrder 续上套餐 完结订单 续费订单新订单</span>
<span class="token keyword">public</span> <span class="token class-name">BExchSvcOrder</span> <span class="token function">setRenewEndOrder</span><span class="token punctuation">(</span><span class="token class-name">BExchSvcOrder</span> order<span class="token punctuation">,</span><span class="token class-name">String</span> dateTime<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查询有无待生效订单,无则正常到期,有则续上套餐</span>
    <span class="token comment">// 调用mongoPageQuery方法，查询待生效订单</span>
    <span class="token comment">// 查询有无待生效订单:{}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span> <span class="token string">&quot;待生效订单&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// setEndOldOrder 完结旧订单 续费完结</span>
        <span class="token comment">// updType (value = &quot;修改事件标签 1普通事件2换电事件&quot;)</span>
        <span class="token comment">// 然后更新订单 旧订单 结算状态:{},结算订单:{}</span>
        <span class="token comment">// 续上待生效为新执行中订单</span>
        <span class="token comment">// 服务到期时间</span>
        <span class="token comment">// 生效订单加上上次次数，实际次数</span>
        <span class="token comment">// 自动续租订单内容:{}</span>
        <span class="token comment">// 自动续租状态:{},自动续租订单:{}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 订单退款</span>
<span class="token keyword">public</span> <span class="token class-name">RestRet</span> <span class="token function">orderRefund</span><span class="token punctuation">(</span><span class="token class-name">OrderRefundBO</span> orderRefundBO<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 获取订单</span>
    <span class="token comment">// 创建订单对象</span>
    <span class="token comment">// 实际费用 totalFee Double.parseDouble 退款金额 refundAmount 折扣金额/最终金额 discountA</span>
    <span class="token comment">// 退款金额不能小于等于0</span>
    <span class="token comment">// 退款金额大于可退款最高金额</span>
    <span class="token comment">// 创建WXRefundRequest对象 退款请求</span>
    <span class="token comment">// 设置退款类型 取消订单 余额退款 押金解冻/退款 订单退款,允许部分退款</span>
    <span class="token comment">// 是否全额退款 0否,1是</span>
    <span class="token comment">// 支付方式 默认1微信2支付宝3余额</span>
    <span class="token comment">// 调用服务实现类 refundOfOrder</span>
<span class="token punctuation">}</span>

<span class="token comment">// 订单转让</span>
<span class="token keyword">public</span> <span class="token class-name">RestRet</span> <span class="token function">orderTransfer</span><span class="token punctuation">(</span><span class="token class-name">BExchSvcOrderBO</span> bExchSvcOrderBO<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span> <span class="token comment">// 订单转让</span>
    <span class="token comment">//</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="blockingqueue"><a href="#blockingqueue" class="header-anchor">#</a> BlockingQueue</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> <span class="token comment">// 定义一个阻塞队列接口，继承自队列接口</span>
    <span class="token comment">/**
     * 如果可以立即将指定元素插入此队列而不违反容量限制，则插入该元素，
     * 成功时返回{@code true}，如果当前没有可用空间，则抛出{@code IllegalStateException}。
     * 在使用容量受限的队列时，通常更倾向于使用{@link #offer(Object) offer}。
     *
     * @param e 要添加的元素
     * @return {@code true}（如{@link Collection#add}所指定）
     * @throws IllegalStateException 如果由于容量限制而无法在此时添加元素
     * @throws ClassCastException 如果指定元素的类阻止其被添加到此队列
     * @throws NullPointerException 如果指定元素为null
     * @throws IllegalArgumentException 如果指定元素的某些属性阻止其被添加到此队列
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加元素的方法</span>

    <span class="token comment">/**
     * 如果可以立即将指定元素插入此队列而不违反容量限制，则插入该元素，
     * 成功时返回{@code true}，如果当前没有可用空间，则返回{@code false}。
     * 在使用容量受限的队列时，此方法通常比{@link #add}更可取，
     * 因为{@link #add}只能通过抛出异常来失败。
     *
     * @param e 要添加的元素
     * @return {@code true} 如果元素被添加到此队列，否则{@code false}
     * @throws ClassCastException 如果指定元素的类阻止其被添加到此队列
     * @throws NullPointerException 如果指定元素为null
     * @throws IllegalArgumentException 如果指定元素的某些属性阻止其被添加到此队列
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 尝试添加元素的方法</span>

    <span class="token comment">/**
     * 插入指定元素到此队列，如果必要，等待空间变得可用。
     *
     * @param e 要添加的元素
     * @throws InterruptedException 如果在等待时被中断
     * @throws ClassCastException 如果指定元素的类阻止其被添加到此队列
     * @throws NullPointerException 如果指定元素为null
     * @throws IllegalArgumentException 如果指定元素的某些属性阻止其被添加到此队列
     */</span>
    <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span> <span class="token comment">// 等待插入元素的方法</span>

    <span class="token comment">/**
     * 插入指定元素到此队列，如果必要，等待最多指定的等待时间，
     * 直到空间变得可用。
     *
     * @param e 要添加的元素
     * @param timeout 等待放弃之前的时间，单位为{@code unit}
     * @param unit 一个{@code TimeUnit}，决定如何解释{@code timeout}参数
     * @return {@code true} 如果成功，或者{@code false} 如果在指定的等待时间内空间不可用
     * @throws InterruptedException 如果在等待时被中断
     * @throws ClassCastException 如果指定元素的类阻止其被添加到此队列
     * @throws NullPointerException 如果指定元素为null
     * @throws IllegalArgumentException 如果指定元素的某些属性阻止其被添加到此队列
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span> <span class="token comment">// 带超时的尝试添加元素的方法</span>

    <span class="token comment">/**
     * 检索并移除此队列的头部，如果必要，等待直到元素可用。
     *
     * @return 此队列的头部
     * @throws InterruptedException 如果在等待时被中断
     */</span>
    <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span> <span class="token comment">// 获取并移除头部元素的方法</span>

    <span class="token comment">/**
     * 检索并移除此队列的头部，如果必要，等待最多指定的等待时间，
     * 直到元素可用。
     *
     * @param timeout 等待放弃之前的时间，单位为{@code unit}
     * @param unit 一个{@code TimeUnit}，决定如何解释{@code timeout}参数
     * @return 此队列的头部，或者{@code null} 如果在指定的等待时间内没有元素可用
     * @throws InterruptedException 如果在等待时被中断
     */</span>
    <span class="token class-name">E</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span> <span class="token comment">// 带超时的获取并移除头部元素的方法</span>

    <span class="token comment">/**
     * 返回此队列在没有内存或资源限制的情况下理想上可以接受的额外元素数量，
     * 如果没有内在限制，则返回{@code Integer.MAX_VALUE}。
     *
     * &lt;p&gt;注意，您&lt;em&gt;无法&lt;/em&gt;通过检查{@code remainingCapacity}来判断插入元素是否会成功，
     * 因为可能有其他线程即将插入或移除元素。
     *
     * @return 剩余容量
     */</span>
    <span class="token keyword">int</span> <span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回剩余容量的方法</span>

    <span class="token comment">/**
     * 从此队列中移除指定元素的单个实例（如果存在）。
     * 更正式地说，移除一个元素{@code e}，使得{@code o.equals(e)}，
     * 如果此队列包含一个或多个这样的元素。
     * 如果此队列包含指定元素（或者等价地，如果此队列因调用而发生变化），
     * 则返回{@code true}。
     *
     * @param o 要从此队列中移除的元素（如果存在）
     * @return {@code true} 如果此队列因调用而发生变化
     * @throws ClassCastException 如果指定元素的类与此队列不兼容
     *         （&lt;a href=&quot;../Collection.html#optional-restrictions&quot;&gt;可选&lt;/a&gt;）
     * @throws NullPointerException 如果指定元素为null
     *         （&lt;a href=&quot;../Collection.html#optional-restrictions&quot;&gt;可选&lt;/a&gt;）
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除指定元素的方法</span>

    <span class="token comment">/**
     * 如果此队列包含指定元素，则返回{@code true}。
     * 更正式地说，仅当此队列至少包含一个元素{@code e}使得{@code o.equals(e)}时返回{@code true}。
     *
     * @param o 要检查是否包含在此队列中的对象
     * @return {@code true} 如果此队列包含指定元素
     * @throws ClassCastException 如果指定元素的类与此队列不兼容
     *         （&lt;a href=&quot;../Collection.html#optional-restrictions&quot;&gt;可选&lt;/a&gt;）
     * @throws NullPointerException 如果指定元素为null
     *         （&lt;a href=&quot;../Collection.html#optional-restrictions&quot;&gt;可选&lt;/a&gt;）
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查队列中是否包含指定元素的方法</span>

    <span class="token comment">/**
     * 从此队列中移除所有可用元素并将它们添加到给定集合中。
     * 此操作可能比重复轮询此队列更高效。
     * 在尝试将元素添加到集合{@code c}时遇到的失败可能导致元素
     * 同时存在于两个集合中，或者在抛出相关异常时都不在任何集合中。
     * 尝试将队列排空到自身会导致{@code IllegalArgumentException}。
     * 此外，如果在操作进行时修改了指定集合，则此操作的行为是未定义的。
     *
     * @param c 要转移元素到的集合
     * @return 转移的元素数量
     * @throws UnsupportedOperationException 如果指定集合不支持添加元素
     * @throws ClassCastException 如果此队列的元素类阻止其被添加到指定集合
     * @throws NullPointerException 如果指定集合为null
     * @throws IllegalArgumentException 如果指定集合是此队列，或者此队列的某个元素的属性阻止其被添加到指定集合
     */</span>
    <span class="token keyword">int</span> <span class="token function">drainTo</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将所有可用元素转移到指定集合的方法</span>

    <span class="token comment">/**
     * 从此队列中最多移除给定数量的可用元素并将它们添加到给定集合中。
     * 在尝试将元素添加到集合{@code c}时遇到的失败可能导致元素
     * 同时存在于两个集合中，或者在抛出相关异常时都不在任何集合中。
     * 尝试将队列排空到自身会导致{@code IllegalArgumentException}。
     * 此外，如果在操作进行时修改了指定集合，则此操作的行为是未定义的。
     *
     * @param c 要转移元素到的集合
     * @param maxElements 要转移的最大元素数量
     * @return 转移的元素数量
     * @throws UnsupportedOperationException 如果指定集合不支持添加元素
     * @throws ClassCastException 如果此队列的元素类阻止其被添加到指定集合
     * @throws NullPointerException 如果指定集合为null
     * @throws IllegalArgumentException 如果指定集合是此队列，或者此队列的某个元素的属性阻止其被添加到指定集合
     */</span>
    <span class="token keyword">int</span> <span class="token function">drainTo</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">,</span> <span class="token keyword">int</span> maxElements<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将最多指定数量的元素转移到指定集合的方法</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="linkedblockingqueue"><a href="#linkedblockingqueue" class="header-anchor">#</a> LinkedBlockingQueue</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token comment">// 定义一个链表阻塞队列类，继承自抽象队列</span>
        <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span> <span class="token comment">// 实现阻塞队列接口和可序列化接口</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">6903933977591709194L</span><span class="token punctuation">;</span> <span class="token comment">// 序列化ID</span>

    <span class="token comment">/*
     * &quot;双锁队列&quot;算法的变体。putLock控制插入（和offer）的进入，
     * 并具有一个与之相关的条件，用于等待插入。takeLock也是如此。
     * 它们都依赖的“计数”字段作为原子变量维护，以避免在大多数情况下
     * 需要获取两个锁。此外，为了最小化插入和取出锁的需求，
     * 使用级联通知。当一个插入操作注意到它启用了至少一个取出时，
     * 它会通知取出者。取出者反过来会通知其他人，如果在信号之后
     * 进入了更多项目。取出操作也会通知插入操作。
     * 
     * 写入者和读取者之间的可见性如下：
     * 
     * 每当一个元素被入队时，获取putLock并更新计数。
     * 随后的读取者通过获取putLock（通过fullyLock）
     * 或获取takeLock，然后读取n = count.get()来保证对入队节点的可见性；
     * 这给出了前n个项目的可见性。
     * 
     * 为了实现弱一致性迭代器，似乎我们需要保持所有节点
     * 从前驱出队节点可达。这会导致两个问题：
     * - 允许恶意迭代器导致无限内存保留
     * - 如果一个节点在存活时被晋升为老年代，导致跨代链接
     *   旧节点和新节点，代际GC对此处理困难，导致重复的重大收集。
     * 然而，只有未删除的节点需要从出队节点可达，
     * 可达性不一定必须是GC理解的那种。
     * 我们使用将刚刚出队的节点链接到自身的技巧。
     * 这样的自链接隐含地意味着向head.next推进。
     */</span>

    <span class="token comment">/**
     * 链表节点类
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> <span class="token comment">// 定义节点类</span>
        <span class="token class-name">E</span> item<span class="token punctuation">;</span> <span class="token comment">// 节点存储的元素</span>

        <span class="token comment">/**
         * 可能是：
         * - 真实的后继节点
         * - 该节点，意味着后继是head.next
         * - null，意味着没有后继（这是最后一个节点）
         */</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">;</span> <span class="token comment">// 指向下一个节点</span>

        <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">E</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span> item <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 节点构造函数</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** 容量限制，如果没有则为Integer.MAX_VALUE */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span> <span class="token comment">// 队列的最大容量</span>

    <span class="token comment">/** 当前元素数量 */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前元素计数</span>

    <span class="token comment">/**
     * 链表的头部。
     * 不变式：head.item == null
     */</span>
    <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> head<span class="token punctuation">;</span> <span class="token comment">// 链表头部节点</span>

    <span class="token comment">/**
     * 链表的尾部。
     * 不变式：last.next == null
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> last<span class="token punctuation">;</span> <span class="token comment">// 链表尾部节点</span>

    <span class="token comment">/** 由take、poll等持有的锁 */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取出操作的锁</span>

    <span class="token comment">/** 等待取出的等待队列 */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty <span class="token operator">=</span> takeLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待非空条件</span>

    <span class="token comment">/** 由put、offer等持有的锁 */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 插入操作的锁</span>

    <span class="token comment">/** 等待插入的等待队列 */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull <span class="token operator">=</span> putLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待非满条件</span>

    <span class="token comment">/**
     * 通知等待的取出操作。仅从put/offer调用（否则不锁定takeLock）。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">signalNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 通知有元素可取</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takeLock<span class="token punctuation">;</span> <span class="token comment">// 获取取出锁</span>
        takeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知等待的取出操作</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 通知等待的插入操作。仅从take/poll调用。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">signalNotFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 通知有空间可插入</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putLock<span class="token punctuation">;</span> <span class="token comment">// 获取插入锁</span>
        putLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知等待的插入操作</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将节点链接到队列的末尾。
     *
     * @param node 节点
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 将节点入队</span>
        <span class="token comment">// assert putLock.isHeldByCurrentThread(); // 确保当前线程持有插入锁</span>
        <span class="token comment">// assert last.next == null; // 确保最后一个节点的next为null</span>
        last <span class="token operator">=</span> last<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment">// 将新节点链接到链表末尾</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从队列头部移除一个节点。
     *
     * @return 移除的节点
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">E</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 将节点出队</span>
        <span class="token comment">// assert takeLock.isHeldByCurrentThread(); // 确保当前线程持有取出锁</span>
        <span class="token comment">// assert head.item == null; // 确保头部节点的item为null</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> h <span class="token operator">=</span> head<span class="token punctuation">;</span> <span class="token comment">// 获取头部节点</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> first <span class="token operator">=</span> h<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 获取第一个实际节点</span>
        h<span class="token punctuation">.</span>next <span class="token operator">=</span> h<span class="token punctuation">;</span> <span class="token comment">// 帮助GC，清除头部节点的next引用</span>
        head <span class="token operator">=</span> first<span class="token punctuation">;</span> <span class="token comment">// 更新头部节点</span>
        <span class="token class-name">E</span> x <span class="token operator">=</span> first<span class="token punctuation">.</span>item<span class="token punctuation">;</span> <span class="token comment">// 获取第一个节点的元素</span>
        first<span class="token punctuation">.</span>item <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 清除第一个节点的元素引用</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span> <span class="token comment">// 返回出队的元素</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 锁定以防止同时进行插入和取出操作。
     */</span>
    <span class="token keyword">void</span> <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 完全锁定</span>
        putLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁定插入锁</span>
        takeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁定取出锁</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 解锁以允许同时进行插入和取出操作。
     */</span>
    <span class="token keyword">void</span> <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 完全解锁</span>
        takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁取出锁</span>
        putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁插入锁</span>
    <span class="token punctuation">}</span>

<span class="token comment">//     /**</span>
<span class="token comment">//      * 告诉当前线程是否持有两个锁。</span>
<span class="token comment">//      */</span>
<span class="token comment">//     boolean isFullyLocked() {</span>
<span class="token comment">//         return (putLock.isHeldByCurrentThread() &amp;&amp;</span>
<span class="token comment">//                 takeLock.isHeldByCurrentThread());</span>
<span class="token comment">//     }</span>

    <span class="token comment">/**
     * 创建一个容量为{@link Integer#MAX_VALUE}的{@code LinkedBlockingQueue}。
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 默认构造函数</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用带容量参数的构造函数</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建一个具有给定（固定）容量的{@code LinkedBlockingQueue}。
     *
     * @param capacity 此队列的容量
     * @throws IllegalArgumentException 如果{@code capacity}不大于零
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 带容量参数的构造函数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>capacity <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查容量是否合法</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span> <span class="token comment">// 设置容量</span>
        last <span class="token operator">=</span> head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化头部和尾部节点</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建一个容量为{@link Integer#MAX_VALUE}的{@code LinkedBlockingQueue}，
     * 初始包含给定集合的元素，
     * 按集合迭代器的遍历顺序添加。
     *
     * @param c 初始包含的元素集合
     * @throws NullPointerException 如果指定的集合或其任何元素为null
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 带集合参数的构造函数</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用默认容量构造函数</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putLock<span class="token punctuation">;</span> <span class="token comment">// 获取插入锁</span>
        putLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 计数器</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">E</span> e <span class="token operator">:</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 遍历集合</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 检查元素是否为null</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token comment">// 检查是否超过容量</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Queue full&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将元素入队</span>
                <span class="token operator">++</span>n<span class="token punctuation">;</span> <span class="token comment">// 增加计数</span>
            <span class="token punctuation">}</span>
            count<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置当前元素计数</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 此文档注释被重写以删除对大于Integer.MAX_VALUE的集合的引用</span>
    <span class="token comment">/**
     * 返回此队列中的元素数量。
     *
     * @return 此队列中的元素数量
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取队列大小</span>
        <span class="token keyword">return</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回当前元素计数</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 此文档注释是修改后的副本，</span>
    <span class="token comment">// 没有对无限队列的引用。</span>
    <span class="token comment">/**
     * 返回此队列在没有内存或资源限制的情况下理想上可以接受的额外元素数量，
     * 这始终等于此队列的初始容量减去当前的{@code size}。
     *
     * &lt;p&gt;注意，您&lt;em&gt;无法&lt;/em&gt;通过检查{@code remainingCapacity}来判断插入元素是否会成功，
     * 因为可能有其他线程即将插入或移除元素。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取剩余容量</span>
        <span class="token keyword">return</span> capacity <span class="token operator">-</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回剩余容量</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 在此队列的尾部插入指定元素，如果必要，等待空间变得可用。
     *
     * @throws InterruptedException {@inheritDoc}
     * @throws NullPointerException {@inheritDoc}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span> <span class="token comment">// 插入元素的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查元素是否为null</span>
        <span class="token comment">// 注意：所有put/take等操作的约定是预设局部变量</span>
        <span class="token comment">// 以负数表示失败，除非设置。</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 初始化计数</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建新节点</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putLock<span class="token punctuation">;</span> <span class="token comment">// 获取插入锁</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// 获取当前计数</span>
        putLock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可中断地锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
             * 注意，计数在等待保护中使用，尽管它没有被锁保护。
             * 这是有效的，因为此时计数只能减少（所有其他插入都被锁定），
             * 如果它从容量变化，我们（或其他等待的插入）会被通知。
             * 对于其他等待保护中的计数的所有其他使用也是如此。
             */</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果队列已满</span>
                notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待直到有空间</span>
            <span class="token punctuation">}</span>
            <span class="token function">enqueue</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将节点入队</span>
            c <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 增加计数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> capacity<span class="token punctuation">)</span> <span class="token comment">// 如果还有空间</span>
                notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知等待的插入操作</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 如果之前队列为空</span>
            <span class="token function">signalNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知有元素可取</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 在此队列的尾部插入指定元素，如果必要，等待最多指定的等待时间，
     * 直到空间变得可用。
     *
     * @return {@code true} 如果成功，或者{@code false} 如果
     *         指定的等待时间在空间可用之前到期
     * @throws InterruptedException {@inheritDoc}
     * @throws NullPointerException {@inheritDoc}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token comment">// 带超时的插入元素的方法</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查元素是否为null</span>
        <span class="token keyword">long</span> nanos <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将超时转换为纳秒</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 初始化计数</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putLock<span class="token punctuation">;</span> <span class="token comment">// 获取插入锁</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// 获取当前计数</span>
        putLock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可中断地锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果队列已满</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 如果超时</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 返回失败</span>
                nanos <span class="token operator">=</span> notFull<span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span>nanos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待纳秒</span>
            <span class="token punctuation">}</span>
            <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将节点入队</span>
            c <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 增加计数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> capacity<span class="token punctuation">)</span> <span class="token comment">// 如果还有空间</span>
                notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知等待的插入操作</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 如果之前队列为空</span>
            <span class="token function">signalNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知有元素可取</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 如果可以立即将指定元素插入此队列而不超过队列的容量，
     * 则在此队列的尾部插入指定元素，成功时返回{@code true}，
     * 如果此队列已满，则返回{@code false}。
     * 在使用容量受限的队列时，此方法通常比{@link BlockingQueue#add add}方法更可取，
     * 后者只能通过抛出异常来失败。
     *
     * @throws NullPointerException 如果指定元素为null
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 尝试立即插入元素的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查元素是否为null</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// 获取当前计数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token comment">// 如果队列已满</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 返回失败</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 初始化计数</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建新节点</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putLock<span class="token punctuation">;</span> <span class="token comment">// 获取插入锁</span>
        putLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果还有空间</span>
                <span class="token function">enqueue</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将节点入队</span>
                c <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 增加计数</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> capacity<span class="token punctuation">)</span> <span class="token comment">// 如果还有空间</span>
                    notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知等待的插入操作</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 如果之前队列为空</span>
            <span class="token function">signalNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知有元素可取</span>
        <span class="token keyword">return</span> c <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回是否成功</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span> <span class="token comment">// 获取并移除头部元素的方法</span>
        <span class="token class-name">E</span> x<span class="token punctuation">;</span> <span class="token comment">// 存储出队元素</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 初始化计数</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// 获取当前计数</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takeLock<span class="token punctuation">;</span> <span class="token comment">// 获取取出锁</span>
        takeLock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可中断地锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果队列为空</span>
                notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待直到有元素可取</span>
            <span class="token punctuation">}</span>
            x <span class="token operator">=</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 出队元素</span>
            c <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 减少计数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 如果还有元素</span>
                notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知等待的取出操作</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token comment">// 如果之前队列已满</span>
            <span class="token function">signalNotFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知有空间可插入</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span> <span class="token comment">// 返回出队的元素</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span> <span class="token comment">// 带超时的获取并移除头部元素的方法</span>
        <span class="token class-name">E</span> x <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 存储出队元素</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 初始化计数</span>
        <span class="token keyword">long</span> nanos <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将超时转换为纳秒</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// 获取当前计数</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takeLock<span class="token punctuation">;</span> <span class="token comment">// 获取取出锁</span>
        takeLock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可中断地锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果队列为空</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 如果超时</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 返回null</span>
                nanos <span class="token operator">=</span> notEmpty<span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span>nanos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待纳秒</span>
            <span class="token punctuation">}</span>
            x <span class="token operator">=</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 出队元素</span>
            c <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 减少计数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 如果还有元素</span>
                notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知等待的取出操作</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token comment">// 如果之前队列已满</span>
            <span class="token function">signalNotFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知有空间可插入</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span> <span class="token comment">// 返回出队的元素</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取并移除头部元素的方法</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// 获取当前计数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 如果队列为空</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 返回null</span>
        <span class="token class-name">E</span> x <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 存储出队元素</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 初始化计数</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takeLock<span class="token punctuation">;</span> <span class="token comment">// 获取取出锁</span>
        takeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果队列不为空</span>
                x <span class="token operator">=</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 出队元素</span>
                c <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 减少计数</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 如果还有元素</span>
                    notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知等待的取出操作</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token comment">// 如果之前队列已满</span>
            <span class="token function">signalNotFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知有空间可插入</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span> <span class="token comment">// 返回出队的元素</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 查看头部元素的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 如果队列为空</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 返回null</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takeLock<span class="token punctuation">;</span> <span class="token comment">// 获取取出锁</span>
        takeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> first <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 获取第一个实际节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果没有节点</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 返回null</span>
            <span class="token keyword">else</span>
                <span class="token keyword">return</span> first<span class="token punctuation">.</span>item<span class="token punctuation">;</span> <span class="token comment">// 返回头部元素</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 与前驱trail一起取消链接内部节点p。
     */</span>
    <span class="token keyword">void</span> <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> trail<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 取消节点链接的方法</span>
        <span class="token comment">// assert isFullyLocked(); // 确保当前线程持有两个锁</span>
        <span class="token comment">// p.next未更改，以允许遍历p的迭代器保持其弱一致性保证。</span>
        p<span class="token punctuation">.</span>item <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 清除节点的元素引用</span>
        trail<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 将前驱节点的next指向p的下一个节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token comment">// 如果p是最后一个节点</span>
            last <span class="token operator">=</span> trail<span class="token punctuation">;</span> <span class="token comment">// 更新最后一个节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token comment">// 如果计数减少到容量</span>
            notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知有空间可插入</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从此队列中移除指定元素的单个实例（如果存在）。
     * 更正式地说，移除一个元素{@code e}，使得{@code o.equals(e)}，
     * 如果此队列包含一个或多个这样的元素。
     * 如果此队列包含指定元素（或者等价地，如果此队列因调用而发生变化），
     * 则返回{@code true}。
     *
     * @param o 要从此队列中移除的元素（如果存在）
     * @return {@code true} 如果此队列因调用而发生变化
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 移除指定元素的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 检查元素是否为null</span>
        <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> trail <span class="token operator">=</span> head<span class="token punctuation">,</span> p <span class="token operator">=</span> trail<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 遍历链表</span>
                 p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                 trail <span class="token operator">=</span> p<span class="token punctuation">,</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果找到匹配的元素</span>
                    <span class="token function">unlink</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> trail<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取消链接</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 返回失败</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回{@code true}如果此队列包含指定元素。
     * 更正式地说，仅当此队列至少包含一个元素{@code e}使得{@code o.equals(e)}时返回{@code true}。
     *
     * @param o 要检查是否包含在此队列中的对象
     * @return {@code true} 如果此队列包含指定元素
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查队列中是否包含指定元素的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 检查元素是否为null</span>
        <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token comment">// 遍历链表</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 如果找到匹配的元素</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 返回失败</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回一个数组，包含此队列中的所有元素，按正确的顺序。
     *
     * &lt;p&gt;返回的数组将是“安全的”，因为此队列不会维护对它的引用。
     * （换句话说，此方法必须分配一个新数组）。
     * 调用者因此可以自由地修改返回的数组。
     *
     * &lt;p&gt;此方法充当数组基础和基于集合的API之间的桥梁。
     *
     * @return 包含此队列中所有元素的数组
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 将队列元素转换为数组的方法</span>
        <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> size <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取当前元素计数</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 创建新数组</span>
            <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 数组索引</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token comment">// 遍历链表</span>
                a<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>item<span class="token punctuation">;</span> <span class="token comment">// 将元素添加到数组</span>
            <span class="token keyword">return</span> a<span class="token punctuation">;</span> <span class="token comment">// 返回数组</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回一个数组，包含此队列中的所有元素，按正确的顺序；
     * 返回数组的运行时类型为指定数组的类型。
     * 如果队列适合指定数组，则返回该数组。
     * 否则，将分配一个新数组，其运行时类型为指定数组的类型，大小为此队列的大小。
     *
     * &lt;p&gt;如果此队列适合指定数组并且有多余的空间
     * （即，数组的元素比此队列多），则数组中紧跟队列末尾的元素设置为
     * {@code null}。
     *
     * &lt;p&gt;像{@link #toArray()}方法一样，此方法充当数组基础和
     * 基于集合的API之间的桥梁。此外，此方法允许
     * 精确控制输出数组的运行时类型，并且在某些情况下，
     * 可以用于节省分配成本。
     *
     * &lt;p&gt;假设{@code x}是一个已知仅包含字符串的队列。
     * 以下代码可以用于将队列转储到新分配的{@code String}数组中：
     *
     *  &lt;pre&gt; {@code String[] y = x.toArray(new String[0]);}&lt;/pre&gt;
     *
     * 注意{@code toArray(new Object[0])}的功能与
     * {@code toArray()}相同。
     *
     * @param a 要存储队列元素的数组，如果足够大；否则，为此目的分配一个新数组
     * @return 包含此队列中所有元素的数组
     * @throws ArrayStoreException 如果指定数组的运行时类型
     *         不是此队列中每个元素的运行时类型的超类型
     * @throws NullPointerException 如果指定数组为null
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 将队列元素转换为指定类型的数组的方法</span>
        <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> size <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取当前元素计数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token comment">// 如果指定数组不够大</span>
                a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Array</span><span class="token punctuation">.</span>newInstance <span class="token comment">// 创建新数组</span>
                    <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getComponentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 数组索引</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token comment">// 遍历链表</span>
                a<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>item<span class="token punctuation">;</span> <span class="token comment">// 将元素添加到数组</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> k<span class="token punctuation">)</span> <span class="token comment">// 如果数组还有空间</span>
                a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 设置数组末尾为null</span>
            <span class="token keyword">return</span> a<span class="token punctuation">;</span> <span class="token comment">// 返回数组</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 转换为字符串的方法</span>
        <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 获取第一个实际节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果没有节点</span>
                <span class="token keyword">return</span> <span class="token string">&quot;[]&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 返回空数组表示</span>

            <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建字符串构建器</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">'['</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加开头的方括号</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 无限循环</span>
                <span class="token class-name">E</span> e <span class="token operator">=</span> p<span class="token punctuation">.</span>item<span class="token punctuation">;</span> <span class="token comment">// 获取当前节点的元素</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">this</span> <span class="token operator">?</span> <span class="token string">&quot;(this Collection)&quot;</span> <span class="token operator">:</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加元素到字符串</span>
                p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 移动到下一个节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果没有下一个节点</span>
                    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">']'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回完整字符串</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">','</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加逗号和空格</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 原子性地移除此队列中的所有元素。
     * 调用此方法后，队列将为空。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 清空队列的方法</span>
        <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">,</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> h<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> h <span class="token operator">=</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 遍历链表</span>
                h<span class="token punctuation">.</span>next <span class="token operator">=</span> h<span class="token punctuation">;</span> <span class="token comment">// 帮助GC，清除节点的next引用</span>
                p<span class="token punctuation">.</span>item <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 清除节点的元素引用</span>
            <span class="token punctuation">}</span>
            head <span class="token operator">=</span> last<span class="token punctuation">;</span> <span class="token comment">// 更新头部节点</span>
            <span class="token comment">// assert head.item == null &amp;&amp; head.next == null; // 确保头部节点为空</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token comment">// 如果计数减少到容量</span>
                notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知有空间可插入</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @throws UnsupportedOperationException {@inheritDoc}
     * @throws ClassCastException            {@inheritDoc}
     * @throws NullPointerException          {@inheritDoc}
     * @throws IllegalArgumentException      {@inheritDoc}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">drainTo</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 将元素转移到指定集合的方法</span>
        <span class="token keyword">return</span> <span class="token function">drainTo</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用带最大元素参数的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @throws UnsupportedOperationException {@inheritDoc}
     * @throws ClassCastException            {@inheritDoc}
     * @throws NullPointerException          {@inheritDoc}
     * @throws IllegalArgumentException      {@inheritDoc}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">drainTo</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">,</span> <span class="token keyword">int</span> maxElements<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 将最多指定数量的元素转移到指定集合的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 检查集合是否为null</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// 检查集合是否为自身</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxElements <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 检查最大元素数量是否合法</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回0</span>
        <span class="token keyword">boolean</span> signalNotFull <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 标记是否需要通知有空间可插入</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takeLock<span class="token punctuation">;</span> <span class="token comment">// 获取取出锁</span>
        takeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>maxElements<span class="token punctuation">,</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取可转移的元素数量</span>
            <span class="token comment">// count.get提供对前n个节点的可见性</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> h <span class="token operator">=</span> head<span class="token punctuation">;</span> <span class="token comment">// 获取头部节点</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 计数器</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 转移元素</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> h<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 获取下一个节点</span>
                    c<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将元素添加到集合</span>
                    p<span class="token punctuation">.</span>item <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 清除节点的元素引用</span>
                    h<span class="token punctuation">.</span>next <span class="token operator">=</span> h<span class="token punctuation">;</span> <span class="token comment">// 帮助GC，清除节点的next引用</span>
                    h <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">// 移动到下一个节点</span>
                    <span class="token operator">++</span>i<span class="token punctuation">;</span> <span class="token comment">// 增加计数</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> n<span class="token punctuation">;</span> <span class="token comment">// 返回转移的元素数量</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// 即使c.add()抛出异常，也要恢复不变式</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果有元素转移</span>
                    <span class="token comment">// assert h.item == null; // 确保当前节点为空</span>
                    head <span class="token operator">=</span> h<span class="token punctuation">;</span> <span class="token comment">// 更新头部节点</span>
                    signalNotFull <span class="token operator">=</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token operator">-</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> capacity<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 更新计数并检查是否需要通知</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>signalNotFull<span class="token punctuation">)</span> <span class="token comment">// 如果需要通知</span>
                <span class="token function">signalNotFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知有空间可插入</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回一个迭代器，按正确顺序遍历此队列中的元素。
     * 元素将按从第一个（头部）到最后一个（尾部）的顺序返回。
     *
     * &lt;p&gt;返回的迭代器是
     * &lt;a href=&quot;package-summary.html#Weakly&quot;&gt;&lt;i&gt;弱一致性&lt;/i&gt;&lt;/a&gt;。
     *
     * @return 一个按正确顺序遍历此队列中元素的迭代器
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取迭代器的方法</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Itr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回新的迭代器实例</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Itr</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> <span class="token comment">// 定义迭代器类</span>
        <span class="token comment">/*
         * 基本的弱一致性迭代器。始终持有下一个
         * 要返回的元素，以便如果hasNext()报告为true，
         * 我们仍然可以返回它，即使与取出等操作竞争失败。
         */</span>

        <span class="token keyword">private</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> current<span class="token punctuation">;</span> <span class="token comment">// 当前节点</span>
        <span class="token keyword">private</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> lastRet<span class="token punctuation">;</span> <span class="token comment">// 上一个返回的节点</span>
        <span class="token keyword">private</span> <span class="token class-name">E</span> currentElement<span class="token punctuation">;</span> <span class="token comment">// 当前元素</span>

        <span class="token class-name">Itr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 迭代器构造函数</span>
            <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                current <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 获取第一个实际节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果节点不为空</span>
                    currentElement <span class="token operator">=</span> current<span class="token punctuation">.</span>item<span class="token punctuation">;</span> <span class="token comment">// 获取当前元素</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查是否还有下一个元素的方法</span>
            <span class="token keyword">return</span> current <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 如果当前节点不为空，返回true</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 返回p的下一个有效后继节点，如果没有则返回null。
         *
         * 与其他遍历方法不同，迭代器需要处理：
         * - 出队节点（p.next == p）
         * - （可能多个）内部删除节点（p.item == null）
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">nextNode</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取下一个节点的方法</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 无限循环</span>
                <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> s <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 获取下一个节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token comment">// 如果是自链接</span>
                    <span class="token keyword">return</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 返回头部的下一个节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>item <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果节点为空或有效</span>
                    <span class="token keyword">return</span> s<span class="token punctuation">;</span> <span class="token comment">// 返回有效节点</span>
                p <span class="token operator">=</span> s<span class="token punctuation">;</span> <span class="token comment">// 移动到下一个节点</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取下一个元素的方法</span>
            <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果没有下一个元素</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出异常</span>
                <span class="token class-name">E</span> x <span class="token operator">=</span> currentElement<span class="token punctuation">;</span> <span class="token comment">// 获取当前元素</span>
                lastRet <span class="token operator">=</span> current<span class="token punctuation">;</span> <span class="token comment">// 更新上一个返回的节点</span>
                current <span class="token operator">=</span> <span class="token function">nextNode</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取下一个节点</span>
                currentElement <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> current<span class="token punctuation">.</span>item<span class="token punctuation">;</span> <span class="token comment">// 更新当前元素</span>
                <span class="token keyword">return</span> x<span class="token punctuation">;</span> <span class="token comment">// 返回当前元素</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 移除当前元素的方法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastRet <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果没有上一个返回的节点</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出异常</span>
            <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> node <span class="token operator">=</span> lastRet<span class="token punctuation">;</span> <span class="token comment">// 获取上一个返回的节点</span>
                lastRet <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 清除上一个返回的节点</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> trail <span class="token operator">=</span> head<span class="token punctuation">,</span> p <span class="token operator">=</span> trail<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 遍历链表</span>
                     p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                     trail <span class="token operator">=</span> p<span class="token punctuation">,</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果找到要移除的节点</span>
                        <span class="token function">unlink</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> trail<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取消链接</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 退出循环</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** 自定义的Spliterators.IteratorSpliterator变体 */</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">LBQSpliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> <span class="token comment">// 定义Spliterator类</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_BATCH</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">25</span><span class="token punctuation">;</span>  <span class="token comment">// 最大批处理数组大小；</span>
        <span class="token keyword">final</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span> <span class="token comment">// 队列引用</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> current<span class="token punctuation">;</span>    <span class="token comment">// 当前节点；初始化前为null</span>
        <span class="token keyword">int</span> batch<span class="token punctuation">;</span>          <span class="token comment">// 分割的批处理大小</span>
        <span class="token keyword">boolean</span> exhausted<span class="token punctuation">;</span>  <span class="token comment">// 当没有更多节点时为true</span>
        <span class="token keyword">long</span> est<span class="token punctuation">;</span>           <span class="token comment">// 大小估计</span>
        <span class="token class-name">LBQSpliterator</span><span class="token punctuation">(</span><span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 构造函数</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span> <span class="token comment">// 设置队列引用</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>est <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化大小估计</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">estimateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> est<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 返回估计大小</span>

        <span class="token keyword">public</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">trySplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 尝试分割的方法</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> h<span class="token punctuation">;</span> <span class="token comment">// 当前节点</span>
            <span class="token keyword">final</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">;</span> <span class="token comment">// 获取队列引用</span>
            <span class="token keyword">int</span> b <span class="token operator">=</span> batch<span class="token punctuation">;</span> <span class="token comment">// 获取当前批处理大小</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span>b <span class="token operator">&gt;=</span> <span class="token constant">MAX_BATCH</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">MAX_BATCH</span> <span class="token operator">:</span> b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 计算新的批处理大小</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exhausted <span class="token operator">&amp;&amp;</span> <span class="token comment">// 如果没有耗尽</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> current<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> q<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// 获取当前节点或头部的下一个节点</span>
                h<span class="token punctuation">.</span>next <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果下一个节点不为空</span>
                <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 创建新数组</span>
                <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 数组索引</span>
                <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> current<span class="token punctuation">;</span> <span class="token comment">// 获取当前节点</span>
                q<span class="token punctuation">.</span><span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> q<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果当前节点不为空或头部的下一个节点不为空</span>
                        <span class="token keyword">do</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>item<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 将节点的元素添加到数组</span>
                                <span class="token operator">++</span>i<span class="token punctuation">;</span> <span class="token comment">// 增加计数</span>
                        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 遍历节点</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    q<span class="token punctuation">.</span><span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>current <span class="token operator">=</span> p<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 更新当前节点</span>
                    est <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span> <span class="token comment">// 更新估计大小</span>
                    exhausted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 标记为耗尽</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>est <span class="token operator">-=</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token comment">// 更新估计大小</span>
                    est <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span> <span class="token comment">// 确保不为负</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果有元素转移</span>
                    batch <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token comment">// 更新批处理大小</span>
                    <span class="token keyword">return</span> <span class="token class-name">Spliterators</span><span class="token punctuation">.</span>spliterator <span class="token comment">// 返回Spliterator</span>
                        <span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token class-name">Spliterator</span><span class="token punctuation">.</span><span class="token constant">ORDERED</span> <span class="token operator">|</span> <span class="token class-name">Spliterator</span><span class="token punctuation">.</span><span class="token constant">NONNULL</span> <span class="token operator">|</span>
                         <span class="token class-name">Spliterator</span><span class="token punctuation">.</span><span class="token constant">CONCURRENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 返回null</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">forEachRemaining</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 对剩余元素执行操作的方法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查操作是否为null</span>
            <span class="token keyword">final</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">;</span> <span class="token comment">// 获取队列引用</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exhausted<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果没有耗尽</span>
                exhausted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 标记为耗尽</span>
                <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> current<span class="token punctuation">;</span> <span class="token comment">// 获取当前节点</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token class-name">E</span> e <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 存储元素</span>
                    q<span class="token punctuation">.</span><span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果当前节点为空</span>
                            p <span class="token operator">=</span> q<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 获取头部的下一个节点</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 遍历节点</span>
                            e <span class="token operator">=</span> p<span class="token punctuation">.</span>item<span class="token punctuation">;</span> <span class="token comment">// 获取节点的元素</span>
                            p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 移动到下一个节点</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果元素不为空</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 退出循环</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        q<span class="token punctuation">.</span><span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果元素不为空</span>
                        action<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行操作</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 继续直到没有更多节点</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryAdvance</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 尝试获取下一个元素的方法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查操作是否为null</span>
            <span class="token keyword">final</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">;</span> <span class="token comment">// 获取队列引用</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exhausted<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果没有耗尽</span>
                <span class="token class-name">E</span> e <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 存储元素</span>
                q<span class="token punctuation">.</span><span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果当前节点为空</span>
                        current <span class="token operator">=</span> q<span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 获取头部的下一个节点</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>current <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 遍历节点</span>
                        e <span class="token operator">=</span> current<span class="token punctuation">.</span>item<span class="token punctuation">;</span> <span class="token comment">// 获取节点的元素</span>
                        current <span class="token operator">=</span> current<span class="token punctuation">.</span>next<span class="token punctuation">;</span> <span class="token comment">// 移动到下一个节点</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果元素不为空</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 退出循环</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    q<span class="token punctuation">.</span><span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果没有更多节点</span>
                    exhausted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 标记为耗尽</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果元素不为空</span>
                    action<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行操作</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 返回成功</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 返回失败</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 返回特征的方法</span>
            <span class="token keyword">return</span> <span class="token class-name">Spliterator</span><span class="token punctuation">.</span><span class="token constant">ORDERED</span> <span class="token operator">|</span> <span class="token class-name">Spliterator</span><span class="token punctuation">.</span><span class="token constant">NONNULL</span> <span class="token operator">|</span>
                <span class="token class-name">Spliterator</span><span class="token punctuation">.</span><span class="token constant">CONCURRENT</span><span class="token punctuation">;</span> <span class="token comment">// 返回特征</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回一个{@link Spliterator}，遍历此队列中的元素。
     *
     * &lt;p&gt;返回的spliterator是
     * &lt;a href=&quot;package-summary.html#Weakly&quot;&gt;&lt;i&gt;弱一致性&lt;/i&gt;&lt;/a&gt;。
     *
     * &lt;p&gt;该{@code Spliterator}报告{@link Spliterator#CONCURRENT}，
     * {@link Spliterator#ORDERED}和{@link Spliterator#NONNULL}。
     *
     * @implNote
     * 该{@code Spliterator}实现{@code trySplit}以允许有限的
     * 并行性。
     *
     * @return 一个{@code Spliterator}，遍历此队列中的元素
     * @since 1.8
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">spliterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取Spliterator的方法</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LBQSpliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回新的Spliterator实例</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将此队列保存到流中（即序列化它）。
     *
     * @param s 流
     * @throws java.io.IOException 如果发生I/O错误
     * @serialData 容量被发出（int），后跟所有
     * 其元素（每个都是{@code Object}）按正确顺序，
     * 后跟null
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ObjectOutputStream</span> s<span class="token punctuation">)</span> <span class="token comment">// 序列化方法</span>
        <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>IOException</span> <span class="token punctuation">{</span>

        <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完全锁定</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 写出任何隐藏的内容，加上容量</span>
            s<span class="token punctuation">.</span><span class="token function">defaultWriteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认序列化</span>

            <span class="token comment">// 按正确顺序写出所有元素。</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token comment">// 遍历链表</span>
                s<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写出元素</span>

            <span class="token comment">// 使用尾随null作为哨兵</span>
            s<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写出null</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从流中重建此队列（即反序列化它）。
     * @param s 流
     * @throws ClassNotFoundException 如果找不到序列化对象的类
     * @throws java.io.IOException 如果发生I/O错误
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ObjectInputStream</span> s<span class="token punctuation">)</span> <span class="token comment">// 反序列化方法</span>
        <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 读取容量和任何隐藏的内容</span>
        s<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认反序列化</span>

        count<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化计数</span>
        last <span class="token operator">=</span> head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化头部和尾部节点</span>

        <span class="token comment">// 读取所有元素并放入队列</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
            <span class="token class-name">E</span> item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span>s<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取元素</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 如果读取到null</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 退出循环</span>
            <span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将元素添加到队列</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="reentrantlock"><a href="#reentrantlock" class="header-anchor">#</a> ReentrantLock</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span> <span class="token comment">// 定义一个可重入锁类，实现Lock接口和可序列化接口</span>

    <span class="token comment">/**
     ...
 
      * 这相当于使用{@code ReentrantLock(false)}。
      */</span>
     <span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 默认构造函数</span>
         sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化为非公平锁</span>
     <span class="token punctuation">}</span>
 
     <span class="token comment">/**
      * 创建一个具有给定公平性策略的{@code ReentrantLock}实例。
      *
      * @param fair {@code true}如果此锁应使用公平的排序策略
      */</span>
     <span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 带公平性参数的构造函数</span>
         sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据参数选择公平或非公平锁</span>
     <span class="token punctuation">}</span>
 
     <span class="token comment">/**
      * 获取锁。
      *
      * &lt;p&gt;如果锁未被其他线程持有，则获取锁并立即返回，
      * 将锁持有计数设置为1。
      *
      * &lt;p&gt;如果当前线程已经持有锁，则持有计数
      * 增加1，方法立即返回。
      *
      * &lt;p&gt;如果锁被其他线程持有，则当前线程
      * 在调度目的上被禁用，处于休眠状态，直到锁被获取，
      * 此时锁持有计数设置为1。
      */</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取锁的方法</span>
         sync<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的锁定方法</span>
     <span class="token punctuation">}</span>
 
     <span class="token comment">/**
      * 获取锁，除非当前线程被
      * {@linkplain Thread#interrupt 中断}。
      *
      * &lt;p&gt;如果锁未被其他线程持有，则获取锁并立即返回，
      * 将锁持有计数设置为1。
      *
      * &lt;p&gt;如果当前线程已经持有此锁，则持有计数
      * 增加1，方法立即返回。
      *
      * &lt;p&gt;如果锁被其他线程持有，则当前线程
      * 在调度目的上被禁用，处于休眠状态，直到发生以下两种情况之一：
      *
      * &lt;ul&gt;
      *
      * &lt;li&gt;当前线程获取锁；或
      *
      * &lt;li&gt;其他线程{@linkplain Thread#interrupt 中断}
      * 当前线程。
      *
      * &lt;/ul&gt;
      *
      * &lt;p&gt;如果当前线程获取锁，则锁持有
      * 计数设置为1。
      *
      * &lt;p&gt;如果当前线程：
      *
      * &lt;ul&gt;
      *
      * &lt;li&gt;在进入此方法时设置了中断状态；或
      *
      * &lt;li&gt;在获取锁时被{@linkplain Thread#interrupt 中断}，
      *
      * &lt;/ul&gt;
      * 则抛出{@link InterruptedException}，并清除当前线程的
      * 中断状态。
      *
      * &lt;p&gt;在此实现中，由于此方法是一个显式
      * 中断点，因此优先响应中断，而不是正常或重入获取锁。
      *
      * @throws InterruptedException 如果当前线程被中断
      */</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span> <span class="token comment">// 可中断的获取锁方法</span>
         sync<span class="token punctuation">.</span><span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的可中断获取方法</span>
     <span class="token punctuation">}</span>
 
     <span class="token comment">/**
      * 仅在锁未被其他线程持有时获取锁。
      *
      * &lt;p&gt;如果锁未被其他线程持有，则获取锁并
      * 立即返回，值为{@code true}，将锁持有计数设置为1。
      * 即使此锁已设置为使用公平排序策略，调用{@code tryLock()} &lt;em&gt;将&lt;/em&gt;
      * 立即获取锁（如果可用），无论其他线程是否正在等待锁。
      * 这种“插队”行为在某些情况下可能有用，
      * 尽管它打破了公平性。如果您希望尊重
      * 此锁的公平性设置，请使用
      * {@link #tryLock(long, TimeUnit) tryLock(0, TimeUnit.SECONDS) }
      * 这几乎是等效的（它也检测中断）。
      *
      * &lt;p&gt;如果当前线程已经持有此锁，则持有
      * 计数增加1，方法返回{@code true}。
      *
      * &lt;p&gt;如果锁被其他线程持有，则此方法将返回
      * {@code false}。
      */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 尝试获取锁的方法</span>
         <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用非公平尝试获取方法</span>
     <span class="token punctuation">}</span>
 
     <span class="token comment">/**
      * 如果在给定的等待时间内锁未被其他线程持有，
      * 则获取锁，且当前线程未被
      * {@linkplain Thread#interrupt 中断}。
      *
      * &lt;p&gt;如果锁未被其他线程持有，则获取锁并立即返回
      * 值为{@code true}，将锁持有计数设置为1。如果此锁已设置为使用公平
      * 排序策略，则如果有其他线程在等待锁，则不会获取可用锁。
      * 这与{@link #tryLock()}方法形成对比。如果您希望在公平锁上允许
      * 插队的定时{@code tryLock}，则将定时和非定时形式结合在一起：
      *
      *  &lt;pre&gt; {@code
      * if (lock.tryLock() ||
      *     lock.tryLock(timeout, unit)) {
      *   ...
      * }}&lt;/pre&gt;
      *
      * &lt;p&gt;如果当前线程
      * 已经持有此锁，则持有计数增加1，方法返回{@code true}。
      *
      * &lt;p&gt;如果锁被其他线程持有，则当前线程
      * 在调度目的上被禁用，处于休眠状态，直到发生以下三种情况之一：
      *
      * &lt;ul&gt;
      *
      * &lt;li&gt;当前线程获取锁；或
      *
      * &lt;li&gt;其他线程{@linkplain Thread#interrupt 中断}
      * 当前线程；或
      *
      * &lt;li&gt;指定的等待时间到期
      *
      * &lt;/ul&gt;
      *
      * &lt;p&gt;如果获取锁，则返回值{@code true}，并将
      * 锁持有计数设置为1。
      *
      * &lt;p&gt;如果当前线程：
      *
      * &lt;ul&gt;
      *
      * &lt;li&gt;在进入此方法时设置了中断状态；或
      *
      * &lt;li&gt;在获取锁时被{@linkplain Thread#interrupt 中断}，
      *
      * &lt;/ul&gt;
      * 则抛出{@link InterruptedException}，并清除当前线程的
      * 中断状态。
      *
      * &lt;p&gt;如果指定的等待时间到期，则返回值{@code false}。
      * 如果时间小于或等于零，则方法将不会等待。
      *
      * &lt;p&gt;在此实现中，由于此方法是一个显式
      * 中断点，因此优先响应中断，而不是正常或重入获取锁，
      * 以及报告等待时间的到期。
      *
      * @param timeout 等待锁的时间
      * @param unit 超时参数的时间单位
      * @return {@code true}如果锁是空闲的并被当前线程获取，
      *         或锁已被当前线程持有；{@code false}如果在获取锁之前
      *         等待时间到期
      * @throws InterruptedException 如果当前线程被中断
      * @throws NullPointerException 如果时间单位为null
      */</span>
     <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token comment">// 尝试获取锁的方法，带超时参数</span>
             <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的尝试获取方法</span>
     <span class="token punctuation">}</span>
 
     <span class="token comment">/**
      * 尝试释放此锁。
      *
      * &lt;p&gt;如果当前线程是此锁的持有者，则持有
      * 计数减少。如果持有计数现在为零，则释放锁。
      * 如果当前线程不是此锁的持有者，则抛出
      * {@link IllegalMonitorStateException}。
      *
     
     ...
    public void unlock() { // 释放锁的方法
    
      /**
      * 尝试释放此锁。
      *
      * &lt;p&gt;如果当前线程是此锁的持有者，则持有
      * 计数减少。如果持有计数现在为零，则释放锁。
      * 如果当前线程不是此锁的持有者，则抛出
      * {@link IllegalMonitorStateException}。
      *
      * @throws IllegalMonitorStateException 如果当前线程不持有此锁
      */</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 释放锁的方法</span>
         sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的释放方法</span>
     <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回一个{@link Condition}实例，用于与此
     * {@link Lock}实例一起使用。
     *
     * &lt;p&gt;返回的{@link Condition}实例支持与
     * 内置监视器锁一起使用的相同用法
     * （{@link Object#wait() wait}，{@link Object#notify notify}，和
     * {@link Object#notifyAll notifyAll}）。
     *
     * &lt;ul&gt;
     *
     * &lt;li&gt;如果在调用任何{@link Condition}
     * {@linkplain Condition#await() 等待}或{@linkplain
     * Condition#signal 信号}方法时未持有此锁，则抛出
     * {@link IllegalMonitorStateException}。
     *
     * &lt;li&gt;当调用条件{@linkplain Condition#await() 等待}
     * 方法时，锁被释放，并且在返回之前，
     * 锁被重新获取，持有计数恢复到调用方法时的值。
     *
     * &lt;li&gt;如果线程在等待时被{@linkplain Thread#interrupt 中断}，
     * 则等待将终止，抛出{@link InterruptedException}，并清除线程的
     * 中断状态。
     *
     * &lt;li&gt; 等待线程按FIFO顺序被信号通知。
     *
     * &lt;li&gt; 从等待方法返回的线程的锁重新获取顺序与
     * 最初获取锁的线程相同，默认情况下未指定，但对于
     * &lt;em&gt;公平&lt;/em&gt;锁，优先考虑等待时间最长的线程。
     *
     * &lt;/ul&gt;
     *
     * @return Condition对象
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 创建新的条件对象的方法</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查询当前线程对此锁的持有次数。
     *
     * &lt;p&gt;线程对锁的持有次数是每个未匹配的
     * 解锁操作的锁操作。
     *
     * &lt;p&gt;持有计数信息通常仅用于测试和
     * 调试目的。例如，如果某段代码不应在
     * 已持有锁的情况下进入，则可以断言这一事实：
     *
     *  &lt;pre&gt; {@code
     * class X {
     *   ReentrantLock lock = new ReentrantLock();
     *   // ...
     *   public void m() {
     *     assert lock.getHoldCount() == 0; // 断言持有计数为0
     *     lock.lock(); // 获取锁
     *     try {
     *       // ... 方法体
     *     } finally {
     *       lock.unlock(); // 释放锁
     *     }
     *   }
     * }}&lt;/pre&gt;
     *
     * @return 当前线程对该锁的持有次数，
     *         如果当前线程未持有此锁，则返回零
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取持有计数的方法</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">getHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查询当前线程是否持有此锁。
     *
     * &lt;p&gt;类似于内置监视器锁的{@link Thread#holdsLock(Object)}方法，
     * 此方法通常用于调试和测试。例如，只有在持有锁的情况下
     * 调用的方法可以断言这一点：
     *
     *  &lt;pre&gt; {@code
     * class X {
     *   ReentrantLock lock = new ReentrantLock();
     *   // ...
     *
     *   public void m() {
     *       assert lock.isHeldByCurrentThread(); // 断言当前线程持有锁
     *       // ... 方法体
     *   }
     * }}&lt;/pre&gt;
     *
     * &lt;p&gt;它还可以用于确保可重入锁以非可重入方式使用，例如：
     *
     *  &lt;pre&gt; {@code
     * class X {
     *   ReentrantLock lock = new ReentrantLock();
     *   // ...
     *
     *   public void m() {
     *       assert !lock.isHeldByCurrentThread(); // 断言当前线程未持有锁
     *       lock.lock(); // 获取锁
     *       try {
     *           // ... 方法体
     *       } finally {
     *           lock.unlock(); // 释放锁
     *       }
     *   }
     * }}&lt;/pre&gt;
     *
     * @return 如果当前线程持有此锁，则返回{@code true}，
     *         否则返回{@code false}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查当前线程是否持有锁的方法</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查询是否有任何线程持有此锁。此方法
     * 旨在用于监控系统状态，
     * 而不是用于同步控制。
     *
     * @return 如果任何线程持有此锁，则返回{@code true}，
     *         否则返回{@code false}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查锁是否被持有的方法</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回{@code true}如果此锁的公平性设置为true。
     *
     * @return {@code true}如果此锁的公平性设置为true
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">isFair</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查锁是否为公平锁的方法</span>
        <span class="token keyword">return</span> sync <span class="token keyword">instanceof</span> <span class="token class-name">FairSync</span><span class="token punctuation">;</span> <span class="token comment">// 判断同步对象是否为公平同步</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回当前拥有此锁的线程，或
     * {@code null}如果未被拥有。当此方法被
     * 非拥有者线程调用时，返回值反映了
     * 当前锁状态的最佳努力近似。例如，
     * 即使有线程尝试获取锁，拥有者也可能会
     * 瞬时为{@code null}。
     * 此方法旨在促进构建提供
     * 更广泛锁监控功能的子类。
     *
     * @return 拥有者，或{@code null}如果未被拥有
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Thread</span> <span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取锁的拥有者线程的方法</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查询是否有任何线程在等待获取此锁。注意
     * 由于取消可能随时发生，返回{@code true}
     * 并不保证任何其他线程将来会获取此锁。
     * 此方法主要用于监控系统状态。
     *
     * @return 如果可能有其他线程在等待获取锁，则返回{@code true}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">hasQueuedThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查是否有线程在等待获取锁的方法</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">hasQueuedThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查询给定线程是否在等待获取此
     * 锁。注意由于取消可能随时发生，返回{@code true}
     * 并不保证此线程将来会获取此锁。
     * 此方法主要用于监控系统状态。
     *
     * @param thread 线程
     * @return 如果给定线程在等待获取此锁，则返回{@code true}
     * @throws NullPointerException 如果线程为null
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">hasQueuedThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查指定线程是否在等待获取锁的方法</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">isQueued</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回等待获取此锁的线程数量的估计值。
     * 该值仅为估计，因为线程数量可能在此方法遍历
     * 内部数据结构时动态变化。此方法旨在用于
     * 监控系统状态，而不是用于同步控制。
     *
     * @return 等待此锁的线程的估计数量
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getQueueLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取等待获取锁的线程数量的方法</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">getQueueLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回一个集合，包含可能在等待获取此锁的线程。
     * 由于实际线程集可能在构建此结果时动态变化，
     * 返回的集合仅为最佳努力估计。返回集合的元素
     * 没有特定顺序。此方法旨在促进构建提供
     * 更广泛监控功能的子类。
     *
     * @return 线程集合
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> <span class="token function">getQueuedThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取等待获取锁的线程集合的方法</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">getQueuedThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查询是否有任何线程在等待与此锁关联的给定条件。
     * 注意，由于超时和中断可能随时发生，返回{@code true}
     * 并不保证将来{@code signal}会唤醒任何线程。
     * 此方法主要用于监控系统状态。
     *
     * @param condition 条件
     * @return 如果有任何等待线程，则返回{@code true}
     * @throws IllegalMonitorStateException 如果此锁未被持有
     * @throws IllegalArgumentException 如果给定条件未与此锁关联
     * @throws NullPointerException 如果条件为null
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasWaiters</span><span class="token punctuation">(</span><span class="token class-name">Condition</span> condition<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查是否有线程在等待给定条件的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>condition <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 检查条件是否为null</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出空指针异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>condition <span class="token keyword">instanceof</span> <span class="token class-name">AbstractQueuedSynchronizer<span class="token punctuation">.</span>ConditionObject</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 检查条件是否为同步条件对象</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;not owner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出非法参数异常</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">hasWaiters</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractQueuedSynchronizer<span class="token punctuation">.</span>ConditionObject</span><span class="token punctuation">)</span>condition<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回等待与此锁关联的给定条件的线程数量的估计值。
     * 注意，由于超时和中断可能随时发生，估计值
     * 仅作为实际等待者数量的上限。
     * 此方法旨在用于监控系统状态，而不是用于同步控制。
     *
     * @param condition 条件
     * @return 等待线程的估计数量
     * @throws IllegalMonitorStateException 如果此锁未被持有
     * @throws IllegalArgumentException 如果给定条件未与此锁关联
     * @throws NullPointerException 如果条件为null
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getWaitQueueLength</span><span class="token punctuation">(</span><span class="token class-name">Condition</span> condition<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取等待给定条件的线程数量的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>condition <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 检查条件是否为null</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出空指针异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>condition <span class="token keyword">instanceof</span> <span class="token class-name">AbstractQueuedSynchronizer<span class="token punctuation">.</span>ConditionObject</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 检查条件是否为同步条件对象</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;not owner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出非法参数异常</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">getWaitQueueLength</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractQueuedSynchronizer<span class="token punctuation">.</span>ConditionObject</span><span class="token punctuation">)</span>condition<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回一个集合，包含可能在等待与此锁关联的给定条件的线程。
     * 由于实际线程集可能在构建此结果时动态变化，
     * 返回的集合仅为最佳努力估计。返回集合的元素
     * 没有特定顺序。此方法旨在促进构建提供
     * 更广泛条件监控功能的子类。
     *
     * @param condition 条件
     * @return 线程集合
     * @throws IllegalMonitorStateException 如果此锁未被持有
     * @throws IllegalArgumentException 如果给定条件未与此锁关联
     * @throws NullPointerException 如果条件为null
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> <span class="token function">getWaitingThreads</span><span class="token punctuation">(</span><span class="token class-name">Condition</span> condition<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取等待给定条件的线程集合的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>condition <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 检查条件是否为null</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出空指针异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>condition <span class="token keyword">instanceof</span> <span class="token class-name">AbstractQueuedSynchronizer<span class="token punctuation">.</span>ConditionObject</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 检查条件是否为同步条件对象</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;not owner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出非法参数异常</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">getWaitingThreads</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractQueuedSynchronizer<span class="token punctuation">.</span>ConditionObject</span><span class="token punctuation">)</span>condition<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用同步对象的方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回一个字符串，标识此锁及其锁状态。
     * 状态在括号中，包括字符串{@code &quot;Unlocked&quot;}
     * 或字符串{@code &quot;Locked by&quot;}，后跟
     * {@linkplain Thread#getName name}的拥有线程。
     *
     * @return 标识此锁及其锁状态的字符串
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 返回锁的字符串表示的方法</span>
        <span class="token class-name">Thread</span> o <span class="token operator">=</span> sync<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取锁的拥有者线程</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token comment">// 返回锁的状态</span>
                <span class="token string">&quot;[Unlocked]&quot;</span> <span class="token operator">:</span>
                <span class="token string">&quot;[Locked by thread &quot;</span> <span class="token operator">+</span> o<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回锁被哪个线程持有</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="lock"><a href="#lock" class="header-anchor">#</a> Lock</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span> <span class="token comment">// 定义一个锁接口</span>

    <span class="token comment">/**
     * 获取锁。
     *
     * &lt;p&gt;如果锁不可用，则当前线程将被禁用
     * 以进行线程调度，并在锁被获取之前处于休眠状态。
     *
     * &lt;p&gt;&lt;b&gt;实现考虑&lt;/b&gt;
     *
     * &lt;p&gt;一个{@code Lock}实现可能能够检测到锁的错误使用，
     * 例如会导致死锁的调用，并可能在这种情况下抛出
     * （未检查的）异常。该{@code Lock}实现必须记录
     * 这些情况和异常类型。
     */</span>
    <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取锁的方法</span>

    <span class="token comment">/**
     * 获取锁，除非当前线程被
     * {@linkplain Thread#interrupt 中断}。
     *
     * &lt;p&gt;如果锁可用，则立即获取锁并返回。
     *
     * &lt;p&gt;如果锁不可用，则当前线程将被禁用
     * 以进行线程调度，并在以下两种情况之一发生之前处于休眠状态：
     *
     * &lt;ul&gt;
     * &lt;li&gt;当前线程获取锁；或
     * &lt;li&gt;其他线程{@linkplain Thread#interrupt 中断}当前线程，
     * 并且支持锁获取的中断。
     * &lt;/ul&gt;
     *
     * &lt;p&gt;如果当前线程：
     * &lt;ul&gt;
     * &lt;li&gt;在进入此方法时设置了中断状态；或
     * &lt;li&gt;在获取锁时被{@linkplain Thread#interrupt 中断}，
     * 并且支持锁获取的中断，
     * &lt;/ul&gt;
     * 则抛出{@link InterruptedException}，并清除当前线程的
     * 中断状态。
     *
     * &lt;p&gt;&lt;b&gt;实现考虑&lt;/b&gt;
     *
     * &lt;p&gt;在某些实现中，可能无法中断锁获取，
     * 如果可能，可能是一个昂贵的操作。
     * 程序员应意识到可能存在这种情况。实现应记录
     * 何时存在这种情况。
     *
     * &lt;p&gt;实现可以优先响应中断而不是正常方法返回。
     *
     * &lt;p&gt;一个{@code Lock}实现可能能够检测到锁的错误使用，
     * 例如会导致死锁的调用，并可能在这种情况下抛出
     * （未检查的）异常。该{@code Lock}实现必须记录
     * 这些情况和异常类型。
     *
     * @throws InterruptedException 如果当前线程在获取锁时被
     *         中断（并且支持锁获取的中断）
     */</span>
    <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span> <span class="token comment">// 可中断的获取锁的方法</span>

    <span class="token comment">/**
     * 仅在调用时锁是空闲的情况下获取锁。
     *
     * &lt;p&gt;如果锁可用，则获取锁并立即返回
     * 值为{@code true}。
     * 如果锁不可用，则此方法将立即返回
     * 值为{@code false}。
     *
     * &lt;p&gt;此方法的典型用法习惯是：
     *  &lt;pre&gt; {@code
     * Lock lock = ...;
     * if (lock.tryLock()) {
     *   try {
     *     // 操作受保护的状态
     *   } finally {
     *     lock.unlock(); // 释放锁
     *   }
     * } else {
     *   // 执行替代操作
     * }}&lt;/pre&gt;
     *
     * 此用法确保如果获取了锁，则锁会被解锁，
     * 并且如果未获取锁，则不会尝试解锁。
     *
     * @return {@code true} 如果锁被获取，
     *         {@code false} 否则
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 尝试获取锁的方法</span>

    <span class="token comment">/**
     * 如果在给定的等待时间内锁是空闲的，并且当前线程
     * 未被{@linkplain Thread#interrupt 中断}，则获取锁。
     *
     * &lt;p&gt;如果锁可用，则此方法立即返回
     * 值为{@code true}。
     * 如果锁不可用，则当前线程将被禁用
     * 以进行线程调度，并在以下三种情况之一发生之前处于休眠状态：
     * &lt;ul&gt;
     * &lt;li&gt;当前线程获取锁；或
     * &lt;li&gt;其他线程{@linkplain Thread#interrupt 中断}当前线程，
     * 并且支持锁获取的中断；或
     * &lt;li&gt;指定的等待时间到期
     * &lt;/ul&gt;
     *
     * &lt;p&gt;如果获取锁，则返回值{@code true}。
     *
     * &lt;p&gt;如果当前线程：
     * &lt;ul&gt;
     * &lt;li&gt;在进入此方法时设置了中断状态；或
     * &lt;li&gt;在获取锁时被{@linkplain Thread#interrupt 中断}，
     * 并且支持锁获取的中断，
     * &lt;/ul&gt;
     * 则抛出{@link InterruptedException}，并清除当前线程的
     * 中断状态。
     *
     * &lt;p&gt;如果指定的等待时间到期，则返回值{@code false}。
     * 如果时间小于或等于零，则方法将不会等待。
     *
     * &lt;p&gt;&lt;b&gt;实现考虑&lt;/b&gt;
     *
     * &lt;p&gt;在某些实现中，可能无法中断锁获取，
     * 如果可能，可能是一个昂贵的操作。
     * 程序员应意识到可能存在这种情况。实现应记录
     * 何时存在这种情况。
     *
     * &lt;p&gt;实现可以优先响应中断而不是正常
     * 方法返回，或报告超时。
     *
     * &lt;p&gt;一个{@code Lock}实现可能能够检测到锁的错误使用，
     * 例如会导致死锁的调用，并可能在这种情况下抛出
     * （未检查的）异常。该{@code Lock}实现必须记录
     * 这些情况和异常类型。
     *
     * @param time 等待锁的最大时间
     * @param unit {@code time}参数的时间单位
     * @return {@code true} 如果锁被获取，{@code false}
     *         如果在获取锁之前等待时间到期
     *
     * @throws InterruptedException 如果当前线程在获取锁时被中断
     *         （并且支持锁获取的中断）
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span> <span class="token comment">// 尝试获取锁的方法，带超时参数</span>

    <span class="token comment">/**
     * 释放锁。
     *
     * &lt;p&gt;&lt;b&gt;实现考虑&lt;/b&gt;
     *
     * &lt;p&gt;一个{@code Lock}实现通常会对哪个线程可以释放锁施加
     * 限制（通常只有锁的持有者可以释放它），并且如果违反限制，
     * 可能会抛出（未检查的）异常。
     * 任何限制和异常类型必须由该{@code Lock}实现记录。
     */</span>
    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放锁的方法</span>

    <span class="token comment">/**
     * 返回一个新的{@link Condition}实例，该实例绑定到此
     * {@code Lock}实例。
     *
     * &lt;p&gt;在等待条件之前，当前线程必须持有锁。
     * 调用{@link Condition#await()}将原子释放锁
     * 然后等待，并在等待返回之前重新获取锁。
     *
     * &lt;p&gt;&lt;b&gt;实现考虑&lt;/b&gt;
     *
     * &lt;p&gt;{@link Condition}实例的确切操作取决于
     * {@code Lock}实现，必须由该实现记录。
     *
     * @return 绑定到此{@code Lock}实例的新{@link Condition}实例
     * @throws UnsupportedOperationException 如果此{@code Lock}
     *         实现不支持条件
     */</span>
    <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建新的条件对象的方法</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="executorservice"><a href="#executorservice" class="header-anchor">#</a> ExecutorService</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//ExecutorService// 定义一个ExecutorService接口，继承自Executor，是 Executor的扩展，中文 翻译为执行器服务</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExecutorService</span> <span class="token keyword">extends</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span> <span class="token comment">// 定义一个ExecutorService接口，继承自Executor</span>

    <span class="token comment">/**
     * 启动有序关闭，其中之前提交的任务将被执行，
     * 但不接受新任务。
     * 如果已经关闭，则调用没有额外效果。
     *
     * &lt;p&gt;此方法不会等待之前提交的任务完成执行。
     * 使用{@link #awaitTermination awaitTermination}来做到这一点。
     *
     * @throws SecurityException 如果存在安全管理器，并且
     *         关闭此ExecutorService可能会操作
     *         调用者不允许修改的线程，因为它不持有
     *         {@link java.lang.RuntimePermission}{@code (&quot;modifyThread&quot;)}，
     *         或安全管理器的{@code checkAccess}方法拒绝访问。
     */</span>
    <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭ExecutorService的方法</span>

    <span class="token comment">/**
     * 尝试停止所有正在执行的任务，停止等待任务的处理，
     * 并返回等待执行的任务列表。
     *
     * &lt;p&gt;此方法不会等待正在执行的任务终止。
     * 使用{@link #awaitTermination awaitTermination}来做到这一点。
     *
     * &lt;p&gt;没有保证会停止正在执行的任务的处理，只有尽力而为。
     * 例如，典型的实现将通过{@link Thread#interrupt}取消，
     * 因此任何未能响应中断的任务可能永远不会终止。
     *
     * @return 从未开始执行的任务列表
     * @throws SecurityException 如果存在安全管理器，并且
     *         关闭此ExecutorService可能会操作
     *         调用者不允许修改的线程，因为它不持有
     *         {@link java.lang.RuntimePermission}{@code (&quot;modifyThread&quot;)}，
     *         或安全管理器的{@code checkAccess}方法拒绝访问。
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 立即关闭ExecutorService并返回未执行的任务列表的方法</span>

    <span class="token comment">/**
     * 如果此执行器已关闭，则返回{@code true}。
     *
     * @return {@code true} 如果此执行器已关闭
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查ExecutorService是否已关闭的方法</span>

    <span class="token comment">/**
     * 如果所有任务在关闭后已完成，则返回{@code true}。
     * 注意，{@code isTerminated}在调用{@code shutdown}或
     * {@code shutdownNow}之前永远不会为{@code true}。
     *
     * @return {@code true} 如果所有任务在关闭后已完成
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查ExecutorService是否已终止的方法</span>

    <span class="token comment">/**
     * 阻塞直到所有任务在关闭请求后完成执行，
     * 或超时发生，或当前线程被中断，以先发生者为准。
     *
     * @param timeout 等待的最大时间
     * @param unit 超时参数的时间单位
     * @return {@code true} 如果此执行器终止，{@code false}
     *         如果在终止之前超时
     * @throws InterruptedException 如果在等待时被中断
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token comment">// 等待ExecutorService终止的方法</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 提交一个返回值的任务进行执行，并返回一个
     * 表示任务待处理结果的Future。Future的{@code get}方法
     * 将在成功完成时返回任务的结果。
     *
     * &lt;p&gt;
     * 如果您希望立即阻塞等待任务，可以使用
     * {@code result = exec.submit(aCallable).get();}的构造。
     *
     * &lt;p&gt;注意：{@link Executors}类包括一组方法
     * 可以将一些其他常见的闭包对象，例如
     * {@link java.security.PrivilegedAction}转换为
     * {@link Callable}形式，以便可以提交。
     *
     * @param task 要提交的任务
     * @param &lt;T&gt; 任务结果的类型
     * @return 表示任务待处理完成的Future
     * @throws RejectedExecutionException 如果任务无法
     *         被调度执行
     * @throws NullPointerException 如果任务为null
     */</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提交Callable任务的方法</span>

    <span class="token comment">/**
     * 提交一个Runnable任务进行执行，并返回一个Future
     * 表示该任务。Future的{@code get}方法将在成功完成时
     * 返回给定的结果。
     *
     * @param task 要提交的任务
     * @param result 要返回的结果
     * @param &lt;T&gt; 结果的类型
     * @return 表示任务待处理完成的Future
     * @throws RejectedExecutionException 如果任务无法
     *         被调度执行
     * @throws NullPointerException 如果任务为null
     */</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">,</span> <span class="token class-name">T</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提交Runnable任务并返回结果的方法</span>

    <span class="token comment">/**
     * 提交一个Runnable任务进行执行，并返回一个Future
     * 表示该任务。Future的{@code get}方法将在成功完成时
     * 返回{@code null}。
     *
     * @param task 要提交的任务
     * @return 表示任务待处理完成的Future
     * @throws RejectedExecutionException 如果任务无法
     *         被调度执行
     * @throws NullPointerException 如果任务为null
     */</span>
    <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提交Runnable任务的方法</span>

    <span class="token comment">/**
     * 执行给定的任务，返回一个Future列表，持有
     * 它们的状态和结果，当所有任务完成时。
     * {@link Future#isDone}对于返回表列的每个元素都是{@code true}。
     * 注意，一个&lt;em&gt;完成的&lt;/em&gt;任务可能正常终止或抛出异常。
     * 如果在此操作进行时修改给定的集合，则此方法的结果是未定义的。
     *
     * @param tasks 任务集合
     * @param &lt;T&gt; 从任务返回的值的类型
     * @return 表示任务的Future列表，顺序与给定任务列表的迭代器生成的顺序相同，
     *         每个任务都已完成
     * @throws InterruptedException 如果在等待时被中断，在这种情况下未完成的任务将被取消
     * @throws NullPointerException 如果任务或其任何元素为{@code null}
     * @throws RejectedExecutionException 如果任何任务无法被调度执行
     */</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">invokeAll</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Callable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tasks<span class="token punctuation">)</span> <span class="token comment">// 执行所有任务并返回结果的方法</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 执行给定的任务，返回一个Future列表，持有
     * 它们的状态和结果，当所有任务完成或超时到期时，
     * 以先发生者为准。
     * {@link Future#isDone}对于返回列表的每个元素都是{@code true}。
     * 返回时，未完成的任务将被取消。
     * 注意，一个&lt;em&gt;完成的&lt;/em&gt;任务可能正常终止或抛出异常。
     * 如果在此操作进行时修改给定的集合，则此方法的结果是未定义的。
     *
     * @param tasks 任务集合
     * @param timeout 等待的最大时间
     * @param unit 超时参数的时间单位
     * @param &lt;T&gt; 从任务返回的值的类型
     * @return 表示任务的Future列表，顺序与给定任务列表的迭代器生成的顺序相同。
     *         如果操作没有超时，则每个任务都将完成。
     *         如果超时，则这些任务中的某些任务将未完成。
     * @throws InterruptedException 如果在等待时被中断，在这种情况下未完成的任务将被取消
     * @throws NullPointerException 如果任务、单位或任何元素任务为{@code null}
     * @throws TimeoutException 如果在任何任务成功完成之前超时到期
     * @throws ExecutionException 如果没有任务成功完成
     * @throws RejectedExecutionException 如果任务无法被调度执行
     */</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">invokeAny</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Callable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tasks<span class="token punctuation">)</span> <span class="token comment">// 执行任务并返回成功结果的方法</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 执行给定的任务，返回一个成功完成的任务的结果
     * （即没有抛出异常），如果有的话。在正常或异常返回时，
     * 未完成的任务将被取消。
     * 如果在此操作进行时修改给定的集合，则此方法的结果是未定义的。
     *
     * @param tasks 任务集合
     * @param &lt;T&gt; 从任务返回的值的类型
     * @return 由一个任务返回的结果
     * @throws InterruptedException 如果在等待时被中断
     * @throws NullPointerException 如果任务或任何元素任务
     *         为{@code null}
     * @throws IllegalArgumentException 如果任务为空
     * @throws ExecutionException 如果没有任务成功完成
     * @throws RejectedExecutionException 如果任务无法被调度执行
     */</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">invokeAny</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Callable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tasks<span class="token punctuation">,</span>
                    <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token comment">// 执行任务并返回成功结果的方法，带超时参数</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">static</span> <span class="token class-name">BlockingQueue</span> blockingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个容量为100的阻塞队列，超过100个等待任务时判定为异常，允许抛出</span>
    <span class="token comment">// 创建一个固定大小的线程池，线程池的核心线程数为当前可用处理器的数量，最大线程数为当前可用处理器的数量乘以4，线程空闲时间超过10秒则被回收</span>
    <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> fixedThreadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 核心线程数</span>
            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// 最大线程数</span>
            <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 线程空闲时间</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token comment">// 时间单位为秒</span>
            blockingQueue<span class="token punctuation">,</span> <span class="token comment">// 使用上面创建的阻塞队列作为任务队列</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 自定义线程工厂</span>
                <span class="token comment">// 定义一个原子整数，用于生成线程的编号</span>
                <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> threadNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 定义线程的名称前缀</span>
                <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> namePrefix <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 线程名称前缀</span>
                <span class="token comment">// 重写newThread方法，用于创建线程</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 创建线程，并设置线程的名称为前缀加上线程编号</span>
                    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> namePrefix <span class="token operator">+</span> threadNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置线程名称</span>
                    <span class="token keyword">return</span> t<span class="token punctuation">;</span> <span class="token comment">// 返回创建的线程</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/JavaPlusDoc/data/data.html" class="prev">
          架构师兼大数据开发工程师
        </a></span> <span class="next"><a href="/JavaPlusDoc/tech/tech.html">
          凯撒加解密
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/JavaPlusDoc/order/order-BizOrderService.html#订单流程" class="sidebar-link reco-side-订单流程" data-v-b57cc07c>订单流程</a></li><li class="level-2" data-v-b57cc07c><a href="/JavaPlusDoc/order/order-BizOrderService.html#blockingqueue" class="sidebar-link reco-side-blockingqueue" data-v-b57cc07c>BlockingQueue</a></li><li class="level-2" data-v-b57cc07c><a href="/JavaPlusDoc/order/order-BizOrderService.html#linkedblockingqueue" class="sidebar-link reco-side-linkedblockingqueue" data-v-b57cc07c>LinkedBlockingQueue</a></li><li class="level-2" data-v-b57cc07c><a href="/JavaPlusDoc/order/order-BizOrderService.html#reentrantlock" class="sidebar-link reco-side-reentrantlock" data-v-b57cc07c>ReentrantLock</a></li><li class="level-2" data-v-b57cc07c><a href="/JavaPlusDoc/order/order-BizOrderService.html#lock" class="sidebar-link reco-side-lock" data-v-b57cc07c>Lock</a></li><li class="level-2" data-v-b57cc07c><a href="/JavaPlusDoc/order/order-BizOrderService.html#executorservice" class="sidebar-link reco-side-executorservice" data-v-b57cc07c>ExecutorService</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到 Jeskson文档-微服务分布式系统架构
    </div> <div class="operation" style="right:90px;bottom:40px;display:none;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:none;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="260" class="live2d" style="width:100px;position:fixed;right:0px;bottom:0px;opacity:0.9;z-index:99999;object-fit:cover;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div></div></div>
    <script src="/JavaPlusDoc/assets/js/app.acda7e78.js" defer></script><script src="/JavaPlusDoc/assets/js/7.6b95bcd8.js" defer></script><script src="/JavaPlusDoc/assets/js/2.d0a351ba.js" defer></script><script src="/JavaPlusDoc/assets/js/1.b7861ce0.js" defer></script><script src="/JavaPlusDoc/assets/js/158.eddd1557.js" defer></script>
  </body>
</html>
